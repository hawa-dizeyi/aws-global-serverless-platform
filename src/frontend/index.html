<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hawser Labs — Global Serverless Platform</title>

    <style>
      :root {
        --bg: #0f1115;
        --card: #151a21;
        --border: #262b36;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --accent: #10a37f;
        --warn: #f59e0b;
        --danger: #ef4444;
        --chip: #0b1220;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        background: radial-gradient(1200px 700px at 50% 0%, rgba(16, 163, 127, 0.06), transparent 55%),
                    var(--bg);
        color: var(--text);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        max-width: 1040px;
        margin: 48px auto;
        padding: 0 20px;
      }

      .topbar {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 18px;
      }

      h1 {
        font-size: 2.2rem;
        margin: 0;
        letter-spacing: -0.02em;
      }

      .subtitle {
        margin-top: 8px;
        color: var(--muted);
        line-height: 1.55;
        max-width: 640px;
      }

      .chips {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .chip {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        background: var(--chip);
        border: 1px solid var(--border);
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 0.85rem;
        color: var(--text);
        transition: transform 200ms ease, border-color 200ms ease;
      }
      .chip strong { font-weight: 650; }
      .chip:hover { transform: translateY(-1px); border-color: #334155; }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--muted);
      }
      .dot.ok { background: var(--accent); }
      .dot.warn { background: var(--warn); }
      .dot.bad { background: var(--danger); }

      .banner {
        background: rgba(245, 158, 11, 0.08);
        border: 1px solid rgba(245, 158, 11, 0.35);
        color: #fde68a;
        padding: 12px 14px;
        border-radius: 14px;
        margin: 14px 0 18px;
        display: none;
        transform: translateY(-6px);
        opacity: 0;
        animation: bannerIn 260ms ease forwards;
      }
      @keyframes bannerIn { to { transform: translateY(0); opacity: 1; } }

      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 18px;
      }
      @media (min-width: 940px) {
        .grid { grid-template-columns: 1fr 1fr; }
      }

      .card {
        background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent 35%),
                    var(--card);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 22px;
        animation: cardIn 260ms ease both;
        box-shadow: 0 8px 28px rgba(0,0,0,0.35);
      }
      @keyframes cardIn {
        from { transform: translateY(10px); opacity: 0.0; }
        to { transform: translateY(0); opacity: 1; }
      }

      .card h2 {
        margin: 0 0 12px;
        font-size: 1.15rem;
      }

      .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }

      .meta {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        color: var(--muted);
        font-size: 0.85rem;
      }

      .pill {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #0b1220;
      }
      .pill .label { color: var(--muted); }
      .pill .value { color: var(--text); font-weight: 650; }

      .controls {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 10px;
      }

      select {
        background: #0b1220;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        outline: none;
      }
      select:hover { border-color: #334155; }

      button {
        appearance: none;
        border: 1px solid var(--border);
        background: #0b1220;
        color: var(--text);
        padding: 10px 16px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 650;
        transition: transform 180ms ease, border-color 180ms ease, color 180ms ease;
      }
      button:hover {
        transform: translateY(-1px);
        border-color: var(--accent);
        color: var(--accent);
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        border-color: var(--border);
        color: var(--muted);
      }

      pre {
        margin: 14px 0 0;
        background: #0b1220;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px;
        overflow-x: auto;
        font-size: 0.86rem;
        white-space: pre-wrap;
        word-break: break-word;
        transition: border-color 220ms ease;
      }

      .pulse { animation: pulse 320ms ease; }
      @keyframes pulse {
        0% { transform: scale(1.0); }
        50% { transform: scale(1.012); }
        100% { transform: scale(1.0); }
      }

      footer {
        margin: 38px 0 10px;
        text-align: center;
        color: var(--muted);
        font-size: 0.82rem;
      }

      a { color: var(--accent); text-decoration: none; }
      a:hover { text-decoration: underline; }

      code {
        background: rgba(255,255,255,0.06);
        padding: 2px 6px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.10);
      }
    </style>
  </head>

  <body>
    <div class="topbar">
      <div>
        <h1>Hawser Labs</h1>
        <div class="subtitle">
          Global serverless platform (active-active) on AWS (Terraform).<br />
          UI hosted publicly (Vercel) to justify <strong>strict CORS</strong>.<br />
          Routing demo: <code>Global</code> uses <code>api.hawser-labs.online</code>, while <code>Force EU/DE</code> calls the regional API endpoints directly.
        </div>
      </div>

      <div class="chips">
        <div class="chip" title="Current region inferred from /health response">
          <span class="dot" id="regionDot"></span>
          <span>Region:</span>
          <strong id="regionBadge">unknown</strong>
        </div>

        <div class="chip" title="Last measured round-trip latency">
          <span class="dot ok"></span>
          <span>Latency:</span>
          <strong id="latencyBadge">—</strong>
        </div>

        <div class="chip" title="Which endpoint the UI is calling">
          <span class="dot warn" id="modeDot"></span>
          <span>Mode:</span>
          <strong id="modeBadge">Global</strong>
        </div>
      </div>
    </div>

    <div class="banner" id="failoverBanner">
      <strong>Failover detected:</strong>
      Region changed from <span id="fromRegion"></span> to <span id="toRegion"></span>.
    </div>

    <div class="card">
      <div class="row">
        <div class="meta">
          <span class="pill"><span class="label">UI Origin</span><span class="value" id="uiOrigin">—</span></span>
          <span class="pill"><span class="label">API Base</span><span class="value" id="apiBaseShown">—</span></span>
        </div>

        <div class="controls">
          <select id="routingMode" onchange="onModeChange()">
            <option value="global">Global (api.hawser-labs.online)</option>
            <option value="eu">Force EU (eu-west-1)</option>
            <option value="de">Force DE (eu-central-1)</option>
          </select>
          <button onclick="checkHealth()">Refresh health</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="cardHealth">
        <div class="row">
          <h2>API Health</h2>
          <div class="meta">
            <span class="pill"><span class="label">Route</span><span class="value">GET /health</span></span>
          </div>
        </div>

        <div class="row" style="margin-top: 10px;">
          <button id="btnHealth" onclick="checkHealth()">Run health check</button>
          <div class="meta">
            <span class="pill"><span class="label">Last status</span><span class="value" id="healthStatus">—</span></span>
            <span class="pill"><span class="label">Latency</span><span class="value" id="healthLatency">—</span></span>
          </div>
        </div>

        <pre id="healthOut">Auto-check will run on page load.</pre>
      </div>

      <div class="card" id="cardWrite">
        <div class="row">
          <h2>Write Demo</h2>
          <div class="meta">
            <span class="pill"><span class="label">Route</span><span class="value">POST /write</span></span>
          </div>
        </div>

        <div class="row" style="margin-top: 10px;">
          <button id="btnWrite" onclick="writeDemo()">Write a demo item</button>
          <div class="meta">
            <span class="pill"><span class="label">Last status</span><span class="value" id="writeStatus">—</span></span>
            <span class="pill"><span class="label">Latency</span><span class="value" id="writeLatency">—</span></span>
          </div>
        </div>

        <pre id="writeOut">Use Global/Force EU/Force DE to demonstrate routing behavior.</pre>
      </div>
    </div>

    <footer>
      API: <a href="https://api.hawser-labs.online/health" target="_blank" rel="noreferrer">api.hawser-labs.online</a>
      • UI: <span class="muted">ui.hawser-labs.online</span>
    </footer>

    <script>
      // Global base (Route53 failover record)
      const API_GLOBAL = "https://api.hawser-labs.online";

      // Regional execute-api endpoints (these have valid TLS certs for their own hostnames)
      // From your terraform outputs:
      const API_EU = "https://9t5g9caak1.execute-api.eu-west-1.amazonaws.com";
      const API_DE = "https://gzntc11016.execute-api.eu-central-1.amazonaws.com";

      let lastRegion = null;

      function currentBase() {
        const mode = document.getElementById("routingMode").value;
        if (mode === "eu") return API_EU;
        if (mode === "de") return API_DE;
        return API_GLOBAL;
      }

      function setModeBadge(mode) {
        const badge = document.getElementById("modeBadge");
        const dot = document.getElementById("modeDot");

        if (mode === "eu") {
          badge.textContent = "Force EU";
          dot.className = "dot ok";
        } else if (mode === "de") {
          badge.textContent = "Force DE";
          dot.className = "dot ok";
        } else {
          badge.textContent = "Global";
          dot.className = "dot warn";
        }
      }

      function setRegionBadge(region) {
        const badge = document.getElementById("regionBadge");
        const dot = document.getElementById("regionDot");

        badge.textContent = region || "unknown";

        dot.classList.remove("ok", "warn", "bad");
        dot.classList.add(region ? "ok" : "warn");
      }

      function showFailover(from, to) {
        const banner = document.getElementById("failoverBanner");
        document.getElementById("fromRegion").textContent = from || "unknown";
        document.getElementById("toRegion").textContent = to || "unknown";

        banner.style.display = "block";
        banner.style.animation = "none";
        banner.offsetHeight; // retrigger
        banner.style.animation = "";
      }

      function setGlobalLatency(ms) {
        document.getElementById("latencyBadge").textContent = `${ms} ms`;
      }

      function prettyJson(text) {
        try {
          const obj = JSON.parse(text);
          return JSON.stringify(obj, null, 2);
        } catch {
          return text;
        }
      }

      async function fetchWithTiming(url, opts) {
        const start = performance.now();
        const res = await fetch(url, opts);
        const end = performance.now();
        const ms = Math.round(end - start);
        return { res, ms };
      }

      function pulse(el) {
        el.classList.remove("pulse");
        void el.offsetWidth;
        el.classList.add("pulse");
      }

      function updateBaseUI() {
        const base = currentBase();
        document.getElementById("apiBaseShown").textContent = base.replace("https://", "");
        document.getElementById("uiOrigin").textContent = window.location.origin;

        const mode = document.getElementById("routingMode").value;
        setModeBadge(mode);
      }

      function onModeChange() {
        updateBaseUI();
        // Force a health refresh when mode changes so badges update immediately
        checkHealth();
      }

      async function checkHealth() {
        const base = currentBase();
        const btn = document.getElementById("btnHealth");
        const out = document.getElementById("healthOut");
        const statusEl = document.getElementById("healthStatus");
        const latEl = document.getElementById("healthLatency");
        const card = document.getElementById("cardHealth");

        btn.disabled = true;
        out.textContent = `Loading...\nRequesting: ${base}/health`;
        statusEl.textContent = "…";
        latEl.textContent = "…";

        try {
          const { res, ms } = await fetchWithTiming(`${base}/health`, { method: "GET" });
          const text = await res.text();

          statusEl.textContent = String(res.status);
          latEl.textContent = `${ms} ms`;
          setGlobalLatency(ms);

          out.textContent = prettyJson(text);
          pulse(card);

          // infer region from JSON
          let region = null;
          try {
            const obj = JSON.parse(text);
            region = obj.region || null;
          } catch {}

          if (region) {
            setRegionBadge(region);

            if (lastRegion && lastRegion !== region) {
              showFailover(lastRegion, region);
            }
            lastRegion = region;
          } else {
            setRegionBadge(null);
          }
        } catch (err) {
          statusEl.textContent = "ERR";
          latEl.textContent = "—";
          out.textContent = "Error: " + (err && err.message ? err.message : String(err));
          pulse(card);
          setRegionBadge(null);
        } finally {
          btn.disabled = false;
        }
      }

      async function writeDemo() {
        const base = currentBase();
        const btn = document.getElementById("btnWrite");
        const out = document.getElementById("writeOut");
        const statusEl = document.getElementById("writeStatus");
        const latEl = document.getElementById("writeLatency");
        const card = document.getElementById("cardWrite");

        btn.disabled = true;
        out.textContent = `Loading...\nRequesting: ${base}/write`;
        statusEl.textContent = "…";
        latEl.textContent = "…";

        try {
          const { res, ms } = await fetchWithTiming(`${base}/write`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pk: "demo" })
          });

          const text = await res.text();

          statusEl.textContent = String(res.status);
          latEl.textContent = `${ms} ms`;
          setGlobalLatency(ms);

          out.textContent = prettyJson(text);
          pulse(card);

          // infer region from JSON
          let region = null;
          try {
            const obj = JSON.parse(text);
            region = obj.item?.region || obj.region || null;
          } catch {}

          if (region) {
            setRegionBadge(region);

            if (lastRegion && lastRegion !== region) {
              showFailover(lastRegion, region);
            }
            lastRegion = region;
          }
        } catch (err) {
          statusEl.textContent = "ERR";
          latEl.textContent = "—";
          out.textContent = "Error: " + (err && err.message ? err.message : String(err));
          pulse(card);
        } finally {
          btn.disabled = false;
        }
      }

      // Init: set mode UI + auto-run health once
      document.addEventListener("DOMContentLoaded", async () => {
        setRegionBadge(null);
        updateBaseUI();
        await checkHealth();
      });
    </script>
  </body>
</html>
